<div class="w-75">
  <%= form_with model: [@project, @task], class: "p-4 border rounded bg-light shadow-sm" do |form| %>

    <% if current_user.admin? || current_user.manager? %>
      <div class="mb-3">
        <%= form.label :title, class: "form-label fw-bold" %>
        <%= form.text_field :title, class: "form-control", placeholder: "Task Title" %>
      </div>

      <div class="mb-3">
        <%= form.label :description, class: "form-label fw-bold" %>
        <%= form.text_area :description, class: "form-control", rows: 5, placeholder: "Task Description" %>
      </div>

      <div class="mb-3">
        <%= form.label :due_date, "Due Date", class: "form-label fw-bold" %>
        <%= form.date_field :due_date, value: @task.due_date&.to_date, class: "form-control" %>
      </div>

      <% if @task.id %>
        <div class="mb-3">
          <%= form.label :contributor_id, "Select an Assignee", class: "fw-bold" %>
          <%= form.select :contributor_id, options_for_select(User.where(role: 0).pluck(:name, :id), selected: @task.contributor_id), {}, { class: "form-select" } %>
        </div>
      <% else %>
        <div class="mb-3">
          <%= form.label :contributor_id, "Select an Assignee", class: "fw-bold" %>
          <%= form.select :contributor_id, options_for_select(User.where(role: 0).pluck(:name, :id)), { prompt: 'Select a Contributor' }, { class: "form-select" } %>
        </div>
      <% end %>

      <!-- <% if @project.tasks.any? %>
        <div class="mb-3">
          <%= form.label :dependent_task_ids, "Select Dependent Tasks" %>
          <%= form.collection_select :dependent_task_ids, @project.tasks.where.not(id: @task.id), :id, :title, { selected: @task.dependent_tasks.pluck(:id), include_hidden: false }, { multiple: true, class: "form-select" } %>
          <small class="text-muted">Tasks selected here must be completed before this task can be marked complete.</small>
        </div>
      <% end %> -->

      <% if @project.tasks.any? %>
        <div class="mb-3">
          <%= form.label :dependent_task_ids, "Select Dependent Tasks", class: "fw-bold" %><br>
          <% @project.tasks.where.not(id: @task.id).each do |task| %>
            <div class="form-check">
              <%= form.check_box :dependent_task_ids, { multiple: true, checked: @task.dependent_tasks.include?(task), class: "form-check-input" }, task.id, nil %>
              <%= form.label "dependent_task_ids_#{task.id}", task.title, class: "form-check-label" %>
            </div>
          <% end %>
          <small class="text-muted">Check tasks that must be completed before this one.</small>
        </div>
      <% end %>

    <% else %>
      <div class="mb-3">
        <%= form.label :title, class: "form-label fw-bold" %>
        <%= form.text_field :title, value: @task.title, readonly: true, class: "form-control text-muted" %>
      </div>

      <div class="mb-3">
        <%= form.label :description, class: "form-label fw-bold" %>
        <%= form.text_area :description, value: @task.description, readonly: true, class: "form-control text-muted", rows: 5 %>
      </div>

      <div class="mb-3">
        <%= form.label :status, "Update Task Status", class: "fw-bold" %>

        <% current_state = @task.aasm.current_state.to_s %>
        <% allowed_states_from_events = @task.aasm.events(permitted: true).map(&:transitions).flatten.map(&:to).map(&:to_s).uniq %>

        <% options = Task.aasm.states.map(&:name).map(&:to_s).map do |state| %>
          <% is_current = (state == current_state) %>
          <% is_allowed = allowed_states_from_events.include?(state) %>

          <% html_options = {} %>
          <% unless is_current || is_allowed %>
            <% html_options[:disabled] = true %>
          <% end %>

          <%# Disable 'blocked' for contributors %>
          <% if current_user.contributor? && state == 'blocked' %>
            <% html_options[:disabled] = true %>
          <% end %>

          <% [state.humanize.upcase, state, html_options] %>
        <% end %>

        <%= select_tag 'task[status]', options_for_select(options, current_state), class: "form-select" %>
      </div>
    <% end %>

    <div class="justify-content-center text-center align-items-center">
      <%= form.submit "Submit", class: "btn btn-primary m-2" %>
      <%= link_to "Back", :back, class: "btn btn-secondary m-2" %>
    </div>

  <% end %>
</div>
